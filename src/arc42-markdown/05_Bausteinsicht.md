title=5. Bausteinsichttype=pagestatus=published~~~~~~Dieser Abschnitt beschreibt die Zerlegung von DokChess in Module, wie sie sich auch in der Paketstruktur des Java-Quelltextes widerspiegelt. Module der ersten Zerlegungsebene bezeichnen wir in DokChess als Subsysteme. Die Bausteinsicht Ebene 1 stellt sie inklusive ihrer Schnittstellen dar. Für das Subsystem Engine enthält dieser Überblick auch eine detailliertere Zerlegung in Ebene 2 (→ 5.6). Abschnitt 6.1 („Zugermittlung Walkthrough“) erklärt exemplarisch das Zusammenspiel der Subsysteme zur Laufzeit.* [5.1	Ebene 1](#5.1)* [5.2 XBoard-Protokoll (Blackbox)](#5.2)* [5.3 Spielregeln (Blackbox)](#5.3)* [5.4 Engine (Blackbox)](#5.4)* [5.5 Eröffnung (Blackbox)](#5.5)* [5.6 Ebene 2: Engine (Whitebox)](#5.6)* [5.7 Zugsuche (Blackbox)](#5.7)* [5.8 Stellungsbewertung (Blackbox)](#5.8)<a name="5.1" class="anchor"></a>## 5.1	Ebene 1DokChess zerfällt wie in Bild unten dargestellt in vier Subsysteme. Die gestrichelten Pfeile stellen fachliche Abhängigkeiten der Subsysteme untereinander dar ("x -> y" für "x ist abhängig von y"). Die Kästchen auf der Membran des Systems sind Interaktionspunkte mit Außenstehenden (→ Kontextabgrenzung 3.2).![DokChess, Bausteinsicht, Ebene 1](images/Abb09_08_Bausteinsicht_Ebene1.png "DokChess, Bausteinsicht, Ebene 1")*Bild: DokChess, Bausteinsicht, Ebene 1**Tabelle: Überblick über Subsysteme von DokChess*| Subsystem | Kurzbeschreibung ||-----------|------------------|| XBoard-Protokoll | Realisiert die Kommunikation mit einem Client mit Hilfe des XBoard-Protokolls. || Spielregeln | Beinhaltet die Schachregeln und kann z.B. zu einer Stellung alle gültigen Züge ermitteln. || Engine | Beinhaltet die Ermittlung eines nächsten Zuges ausgehend von einer Spielsituation. || Eröffnung | Stellt Züge aus der Eröffnungsliteratur zu einer Spielsituation bereit.|<a name="5.2" class="anchor"></a>## 5.2 XBoard-Protokoll (Blackbox)### Zweck/VerantwortlichkeitDieses Subsystem realisiert die Kommunikation mit einem Client (z.B. einer grafischen Oberfläche) mit Hilfe des textbasierten XBoard-Protokolls (→ Entscheidung 9.1). Das Subsystem liest Befehle über die Standardeingabe ein, prüft sie gegen die Spielregeln und setzt sie für die Engine um. Antworten der Engine (insbesondere ihre Züge) werden vom Subsystem als Ereignisse entgegengenommen, gemäß Protokoll formatiert und über die Standardausgabe zurückgesendet. Das Subsystem treibt somit das ganze Spielgeschehen. Es enthält auch die main-Methode.### SchnittstellenDas Subsystem stellt seine Funktionalität über die Java-Klassen _de.dokchess.xboard.XBoard_ und _de.dokchess.xboard.Main_ bereit:![Klassen XBoard und Main](images/Abb09_09_Schnittstellen_Xboard.png "Klassen XBoard und Main")*Bild: Klassen XBoard und Main**Tabelle: Methoden der Klasse XBoard*| Methode | Kurzbeschreibung ||---------|------------------|| setEingabe | Setzt die Protokoll-Eingabe per Dependency Injection (→ Konzept 9.8.1). Typischerweise ist das die Standardeingabe (stdin), automatische Tests z.B. verwenden eine andere Quelle. || setAusgabe | Setzt die Protokoll-Ausgabe. Typischerweise ist das die Standardausgabe (stdout), automatische Tests verwenden eine andere Senke.| setSpielregeln | Setzt eine Implementierung der Spielregeln, → 9.5.3 Spielregeln (Blackbox)| setEngine | Setzt eine Implementierung der Engine, → 9.5.4 Engine (Blackbox) | | spielen | Startet die eigentliche Kommunikation (Eingabe/Verarbeitung/Ausgabe) in einer Endlosschleife, bis zum Beenden-Kommando.|### Ablageort / DateiDie Implementierung liegt unterhalb der Pakete _de.dokchess.xboard..._### Offene PunkteDie Implementierung des Protokolls ist unvollständig. Sie reicht aber für die an DokChess gestellten Anforderungen aus. Insbesondere werden folgende Features nicht unterstützt: * Zeitkontrolle* Permanent Brain (Denken, auch während der andere denkt)* Remis-Angebote und Aufgabe des Gegners* Schach-Varianten (alternative Regeln, z.B. Schach960)<a name="5.3" class="anchor"></a>## 5.3	Spielregeln (Blackbox)### Zweck/VerantwortlichkeitDieses Subsystem beinhaltet die Spielregeln für Schach gemäß Internationalem Schachverband (FIDE). Es ermittelt zu einer Stellung alle gültigen Züge und entscheidet, ob ein Schach, ein Matt oder ein Patt vorliegt.### SchnittstelleDas Subsystem stellt seine Funktionalität über das Java-Interface de.dokchess.regeln.Spielregeln bereit. Default-Implementierung der Schnittstelle ist die Klasse de.dokchess.regeln.DefaultSpielregeln.![Schnittstelle Spielregeln](images/Abb09_10_Schnittstelle_Spielregeln.png "Schnittstelle Spielregeln")*Bild: Schnittstelle Spielregeln**Tabelle: Methoden der Schnittstelle Spielregeln*| Methode | Kurzbeschreibung ||---------|------------------|| liefereGrundaufstellung | Liefert die Grundaufstellung der Figuren zu Beginn einer Partie. Weiß ist am Zug.|| liefereGueltigeZuege | Liefert zu einer Stellung die Menge aller gültigen Züge für den aktuellen Spieler. Der Spieler am Zug wird aus der Stellung ermittelt. Im Falle eines Matt oder Patt wird eine leere Collection zurückgeliefert, das Ergebnis ist also nie null.|| aufSchachPruefen | Püft, ob der König der angegebenen Farbe angegriffen ist, also im Schach steht. | | aufMattPruefen | Prüft, ob die übergebene Stellung ein Matt ist, also der aktuelle Spieler im Schach steht und kein Zug ihn aus diesem Angriff führt. Eine solche Spielsituation ist für den Spieler am Zug verloren ("Schach Matt").|| aufPattPruefen | Prüft, ob die übergebene Stellung ein Patt ist, also der aktuelle Spieler keinen gültigen Zug hat, aber nicht im Schach steht. Eine solche Spielsituation wird Remis gewertet.|Konzept 8.2 („Schach-Domänenmodell“) beschreibt die in der Schnittstelle verwendeten Aufruf- und Rückgabeparameter (Zug, Stellung, Farbe). Weitere Details entnehmen Sie der Quelltextdokumentation (javadoc).### Ablageort / DateiDie Implementierung liegt unterhalb der Pakete _de.dokchess.regeln..._### Offene PunkteAbgesehen vom Patt kann das Subsystem kein Remis erkennen. Insbesondere sind die folgenden Spielregeln bisher nicht implementiert (→ Risiko 11.2 „Aufwand der Implementierung“):* 50-Züge-Regel* Stellungswiederholung<a name="5.4" class="anchor"></a>## 5.4 Engine (Blackbox)### Zweck/VerantwortlichkeitDieses Subsystem beinhaltet die Ermittlung eines nächsten Zuges ausgehend von einer Spielsituation. Diese Situation wird von außen vorgegeben. Die Engine ist zustandsbehaftet und spielt stets eine Partie zur gleichen Zeit. Die Default-Implementierung benötigt zum Arbeiten eine Implementierung der Spielregeln, die Eröffnungsbibliothek hingegen ist optional.### SchnittstellenDas Subsystem stellt seine Funktionalität über das Java-Interface _de.dokchess.engine.Engine_ bereit. Default-Implementierung ist die Klasse _de.dokchess.engine.DefaultEngine_.![Schnittstelle Engine, Implementierung](images/Abb09_11_Schnittstellen_Engine.png "Schnittstelle Engine, Implementierung")*Bild: Schnittstelle Engine, Implementierung**Tabelle: Methoden der Schnittstelle Engine*| Methode | Kurzbeschreibung ||---------|------------------||figurenAufbauen | Setzt den Zustand der Engine auf die angegebene Stellung. Falls aktuell eine Zugermittlung läuft, wird diese abgebrochen.|| ermittleDeinenZug | Startet die Ermittlung eines Zuges für die aktuelle Spielsituation. Liefert Zugkandidaten asynchron über ein Observable zurück (→ Laufzeitsicht 6.1). Die Engine führt die Züge nicht aus.| | ziehen | Führt den angegebenen Zug aus, d.h. ändert den Zustand der Engine. Falls aktuell eine Zugermittlung läuft, wird diese abgebrochen.|| schliessen | Schließt die Engine. Die Methode erlaubt es Ressourcen frei zu geben. Im Anschluss sind keine Zugermittlungen mehr zulässig.|*Tabelle: Methoden der Klasse DefaultEngine (zusätzlich zu Engine)*| Methode | Kurzbeschreibung ||---------|------------------|| setSpielregeln | Setzt eine Implementierung der Spielregeln, → 5.3 Spielregeln (Blackbox)|| setEroeffnungsbibliothek | Setzt eine (optionale) Eröffnungsbibliothek, deren Züge gegenüber eigenen Überlegungen präferiert werden. → 5.5 Eröffnung (Blackbox).|Abschnitt 8.2 („Schach-Domänenmodell“) beschreibt die in der Schnittstelle verwendeten Aufruf- und Rückgabeparameter (Zug, Stellung, Farbe). Details zum Engine-Subsystem finden Sie in der Whitebox-Sicht in Abschnitt 5.6.### Ablageort / DateiDie Implementierung sowie Unit-Tests liegen unterhalb der Pakete _de.dokchess.engine..._<a name="5.5" class="anchor"></a>## 5.5 Eröffnung (Blackbox)### Zweck/VerantwortlichkeitDieses Subsystem stellt Eröffnungsbibliotheken bereit und implementiert das Polyglot Opening Book-Format. Bei diesem Format handelt es sich gegenwärtig um das einzig geläufige, das nicht proprietär ist. Entsprechende Buchdateien und zugehörige Werkzeuge sind im Internet frei verfügbar.SchnittstellenDas Subsystem stellt seine Funktionalität über das Java-Interface _de.dokchess.eroeffnung.Eroeffnungsbibliothek_ bereit. Als Implementierung liegt die Klasse _de.dokchess.eroeffnung.polyglot.PolyglotOpeningBook_ vor.![Schnittstelle Eroeffnungsbibliothek, Implementierung PolyglotOpeningBook](images/Abb09_12_SchnittstellenEroeffnung.png "Schnittstelle Eroeffnungsbibliothek, Implementierung PolyglotOpeningBook")*Bild: Schnittstelle Eroeffnungsbibliothek, Implementierung PolyglotOpeningBook**Tabelle: Methoden der Schnittstelle Eroeffnungsbibliothek*| Methode | Kurzbeschreibung ||---------|------------------|| liefereZug | Liefert zur angegebenen Stellung einen aus der Bibliothek bekannten Zug, oder null |### PolyglotOpeningBookDie Klasse PolyglotOpeningBook ist ein Adapter zum Polyglot Opening Book-Dateiformat. Implementierung der Eroeffnungsbibliothek, die eine Binärdatei im entsprechenden Format einliest und einen Zug zur angegebenen Stellung zurückliefert, falls es einen gibt.*Tabelle: Methoden der Klasse PolyglotOpeningBook (zusätzlich zur Schnittstelle)*| Methode | Kurzbeschreibung ||---------|------------------|| PolyglotOpeningBook | Konstruktor, erwartet die einzulesende Datei.|| setAuswahlModus | Setzt den Modus zur Auswahl eines Zuges, falls es in der Bibliothek für die Stellung mehr als einen Kandidaten gibt.|Abschnitt 8.2 beschreibt die in der Schnittstelle verwendeten Aufruf- und Rückgabeparameter (Zug, Stellung). ### Ablageort / DateiDie Implementierung, Unit-Tests und Testdaten für das Polyglot Opening Book-Fomat liegen unterhalb der Pakete _de.dokchess.eroeffnung..._### Offene Punkte* Die Möglichkeiten zur Auswahl eines Zuges aus der Eröffnungsbibliothek im Fall von mehreren Kandidaten sind beschränkt (der erste, der am häufigsten gespielte, per Zufall).* Die Implementierung kann nicht mit mehreren Bibliotheksdateien zur gleichen Zeit umgehen – sie also nicht mischen – um das Wissen zu vereinen.<a name="5.6" class="anchor"></a>## 5.6 Ebene 2: Engine (Whitebox)Die Engine zerfällt wie in der folgenden Abbildung dargestellt in Zugsuche und Stellungsbewertung. Falls vorhanden wird die Ermittlung des Zuges zunächst an die Eröffnungsbibliothek delegiert. Nur wenn diese keinen Rat weiß, kommt die Zugsuche zum Einsatz.![Subsystem Engine, Bausteinsicht, Ebene 2](images/Abb09_13_Subsystem_Engine.png "Subsystem Engine, Bausteinsicht, Ebene 2")*Bild: Subsystem Engine, Bausteinsicht, Ebene 2**Tabelle: Module des Subsystems Engine*| Modul | Kurzbeschreibung ||-------|------------------|| Zugsuche | Ermittelt zu einer Stellung den unter bestimmten Bedingungen optimalen Zug.|| Stellungsbewertung | Bewertet eine Stellung aus Sicht eines Spielers.|<a name="5.7" class="anchor"></a>## 5.7 Zugsuche (Blackbox)### Zweck/VerantwortlichkeitDas Modul ermittelt zu einer Stellung den unter bestimmten Bedingungen optimalen Zug. Theoretisch gäbe es im Schach einen generell optimalen Zug. Die hohe Anzahl der möglichen Züge und die damit verbundene schier unglaubliche Anzahl zu bewertender Spielsituationen macht es in der Praxis aber unmöglich, ihn zu bestimmen. Gängige Algorithmen wie der Minimax begnügen sich daher damit, den "Spielbaum" nur bis zu einer bestimmten Tiefe zu explorieren.### SchnittstellenDas Modul stellt seine Funktionalität über die Schnittstelle de.dokchess.engine.suche.Suche zur Verfügung. Der Minimax-Algorithmus liegt in der Klasse de.dokchess.engine.suche.MinimaxAlgorithmus vor. Die Klasse MinimaxParalleleSuche nutzt den Algorithmus und implementiert gleichzeitig die Schnittstelle Suche. Sie untersucht mehrere Teilbäume parallel; wenn sie einen besseren Zug findet erhält der Aufrufer eine Nachricht onNext über das Observer-Pattern. Den Abschluss der Suche signalisiert die Suche über die Nachricht onComplete.![Schnittstelle Suche, Klassen MinimaxAlgorithmus und MinimaxParalleleSuche](images/Abb09_14_Schnittstellen_Zugsuche.png "Schnittstelle Suche, Klassen MinimaxAlgorithmus und MinimaxParalleleSuche")*Bild: Schnittstelle Suche, Klassen MinimaxAlgorithmus und MinimaxParalleleSuche**Tabelle: Methoden der Schnittstelle Suche*| Methode | Kurzbeschreibung ||---------|------------------|| zugSuchen | Startet eine Suche nach einem Zug für die angegebene Stellung. Liefert nach und nach bessere Züge als Ereignisse an den übergebenen Observer. Das Ende der Suche (keinen besseren Zug mehr gefunden) wird ebenfalls an den Observer signalisiert.|| sucheAbbrechen | Bricht die aktuelle Suche ab.|| schliessen | Schließt die Suche vollständig. Anschließend dürfen keine Züge mehr damit ermittelt werden.|*Tabelle: Methoden der Klasse MinimaxAlgorithmus*| Methode | Kurzbeschreibung ||---------|------------------|| setSpielregeln | Setzt eine Implementierung der Spielregeln über Dependency Injection, → 5.3 Spielregeln (Blackbox) || setBewertung | Setzt die Bewertungsfunktion, anhand derer die Stellungen bei Erreichen der maximalen Suchtiefe bewertet werden. → 5.8 Stellungsbewertung (Blackbox)|| setTiefe | Setzt die maximale Suchtiefe in Halbzügen, d.h. bei 4 zieht jeder Spieler zweimal.|| ermittleBestenZug | Ermittelt zur übergebenen Stellung den optimalen Zug gemäß Minimax und vorgegebener Stellungsbewertung bei fester Suchtiefe. Die Methode blockiert und ist deterministisch.|### Ablageort / DateiDie Implementierung liegt unterhalb der Pakete _de.dokchess.engine.suche..._<a name="5.8" class="anchor"></a>## 5.8 Stellungsbewertung (Blackbox)### Zweck/VerantwortlichkeitDas Modul bewertet eine Stellung aus Sicht eines Spielers. Ergebnis ist eine Zahl, wobei 0 eine ausgeglichene Situation beschreibt, eine positive Zahl einen Vorteil für den Spieler, eine negative einen Nachteil. Je höher der Betrag, desto größer der Vor- bzw. Nachteil. Das Modul ermöglicht es so, Stellungen miteinander zu vergleichen.### SchnittstellenDas Modul stellt seine Funktionalität über die Schnittstelle de.dokchess.engine.bewertung.Bewertung bereit, de.dokchess.engine.bewertung.ReineMaterialBewertung ist eine sehr einfache Implementierung. Die Schnittstelle enthält Konstanten für typische Bewertungen. ![Schnittstelle Bewertung, Klasse ReineMaterialBewertung](images/Abb09_15_SchnittstellenBewertung.png "Schnittstelle Bewertung, Klasse ReineMaterialBewertung")  *Bild: Schnittstelle Bewertung, Klasse ReineMaterialBewertung**Tabelle: Methoden der Schnittstelle Bewertung*| Methode | Kurzbeschreibung ||---------|------------------|| bewerteStellung | Liefert zur gegebenen Stellung eine Bewertung aus Sicht der angegebenen Spielerfarbe. Je höher, desto besser.|### ReineMaterialBewertung Die Implementierung berücksichtigt ausschließlich die vorhandenen Figuren (Material). Jede Figurenart enthält einen Wert (Bauer 1, Springer 3, ..., Dame 9), die Figuren auf dem Brett werden entsprechend aufsummiert. Eigene Figuren zählen positiv, gegnerische negativ. Entsprechend ist bei ausgeglichenem Material das Ergebnis 0, verliert man z.B. eine Dame, sinkt der Wert um 9. ### Ablageort / DateiDie Implementierung liegt unterhalb der Pakete _de.dokchess.engine.bewertung..._### Offene PunkteBei der reinen Materialbewertung spielt es keine Rolle, wo die Figur steht. Ein Bauer in Startposition ist genau so viel wert, wie einer kurz vor der Umwandlung. Und ein Springer am Rand entspricht einem Springer im Zentrum. Hier ist viel Spielraum für Verbesserungen, der bewusst nicht ausgeschöpft wurde, da DokChess ja zum Experimentieren einladen soll.